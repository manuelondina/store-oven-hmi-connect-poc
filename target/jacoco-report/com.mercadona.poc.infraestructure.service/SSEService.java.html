<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SSEService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Poc Mercadona Backend</a> &gt; <a href="index.source.html" class="el_package">com.mercadona.poc.infraestructure.service</a> &gt; <span class="el_source">SSEService.java</span></div><h1>SSEService.java</h1><pre class="source lang-java linenums">package com.mercadona.poc.infraestructure.service;

import java.io.IOException;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.CopyOnWriteArrayList;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import com.mercadona.poc.constants.MessageTypeEnum;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Service
<span class="nc" id="L21">public class SSEService {</span>

<span class="nc" id="L23">    private final List&lt;SseEmitter&gt; emitters = new CopyOnWriteArrayList&lt;&gt;();</span>
<span class="nc" id="L24">    private static final Logger logger = LoggerFactory.getLogger(HMILoaderService.class);</span>

    public synchronized SseEmitter createAndAddEmitter() {
<span class="nc" id="L27">        SseEmitter emitter = new SseEmitter((long) -1);</span>
<span class="nc" id="L28">        emitters.add(emitter);</span>
<span class="nc" id="L29">        emitter.onCompletion(() -&gt; {</span>
<span class="nc" id="L30">            emitters.remove(emitter);</span>
<span class="nc" id="L31">        });</span>
<span class="nc" id="L32">        return emitter;</span>
    }

    public void sendMessage(String ovenName, String message) throws IOException {
<span class="nc" id="L36">        List&lt;SseEmitter&gt; synchronizedEmitters = Collections.synchronizedList(emitters);</span>

<span class="nc bnc" id="L38" title="All 2 branches missed.">        for (SseEmitter emitter : synchronizedEmitters) {</span>
            try {
<span class="nc" id="L40">                OvenEventData eventData = new OvenEventData(ovenName, message);</span>
                String updatedMessage;
<span class="nc" id="L42">                logger.warn(eventData.getMessage());</span>
<span class="nc bnc" id="L43" title="All 13 branches missed.">                switch (eventData.getMessage()) {</span>
                    case MessageTypeEnum.INICIANDO:
<span class="nc" id="L45">                        updatedMessage = &quot;Iniciando servicio&quot;;</span>
<span class="nc" id="L46">                        break;</span>
                    case MessageTypeEnum.SUBIENDO:
<span class="nc" id="L48">                        updatedMessage = &quot;Subiendo archivos...&quot;;</span>
<span class="nc" id="L49">                        break;</span>
                    case MessageTypeEnum.UNZIP:
<span class="nc" id="L51">                        updatedMessage = &quot;Descomprimiendo...&quot;;</span>
<span class="nc" id="L52">                        break;</span>
                    case MessageTypeEnum.CARGA:
<span class="nc" id="L54">                        updatedMessage = &quot;Empezando carga de horno.&quot;;</span>
<span class="nc" id="L55">                        break;</span>
                    case MessageTypeEnum.MONTANDO:
<span class="nc" id="L57">                        updatedMessage = &quot;Montando el Libro de Recetas en HMI.&quot;;</span>
<span class="nc" id="L58">                        break;</span>
                    case MessageTypeEnum.CONECTANDOHMI:
<span class="nc" id="L60">                        updatedMessage = &quot;Conectando al HMI&quot;;</span>
<span class="nc" id="L61">                        break;</span>
                    case MessageTypeEnum.ACTIVANDOLIBRO:
<span class="nc" id="L63">                        updatedMessage = &quot;Activando Libro de Recetas&quot;;</span>
<span class="nc" id="L64">                        break;</span>
                    case MessageTypeEnum.ERRORHMI:
<span class="nc" id="L66">                        updatedMessage = &quot;Error activando el Libro de recetas.&quot;;</span>
<span class="nc" id="L67">                        break;</span>
                    case MessageTypeEnum.ERROR:
<span class="nc" id="L69">                        updatedMessage = &quot;Ha ocurrido un error.&quot;;</span>
<span class="nc" id="L70">                        break;</span>
                    case MessageTypeEnum.ERRORCONEXIONHMI:
<span class="nc" id="L72">                        updatedMessage = &quot;Existe un problema de conexi√≥n al HMI&quot;;</span>
<span class="nc" id="L73">                        break;</span>
                    case MessageTypeEnum.ERRORENLISTA1:
<span class="nc" id="L75">                        updatedMessage = &quot;No se encuentra Lista_1.txt&quot;;</span>
<span class="nc" id="L76">                        break;</span>
                    case MessageTypeEnum.ERRORENZIP:
<span class="nc" id="L78">                        updatedMessage = &quot;Error de lectura en la carpeta descomprimida&quot;;</span>
<span class="nc" id="L79">                        break;</span>
                    default:
<span class="nc" id="L81">                        logger.warn(eventData.getMessage());</span>
<span class="nc" id="L82">                        updatedMessage = &quot;Error desconocido, por favor contacte con el Equipo de TI.&quot;;</span>
                        break;
                }

<span class="nc" id="L86">                eventData.setMessage(updatedMessage);</span>
<span class="nc" id="L87">                emitter.send(SseEmitter.event().data(eventData, MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L88">            } catch (IOException e) {</span>
<span class="nc" id="L89">                emitter.completeWithError(e);</span>
<span class="nc" id="L90">            }</span>
<span class="nc" id="L91">        }</span>
<span class="nc" id="L92">    }</span>

    public synchronized void sendMessageAndValue(String ovenName, String message, String value) throws IOException {
<span class="nc bnc" id="L95" title="All 2 branches missed.">        for (SseEmitter emitter : emitters) {</span>
            try {
<span class="nc" id="L97">                OvenEventData eventData = new OvenEventData(ovenName, message);</span>
                String updatedMessage;

<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (eventData.getMessage().equals(MessageTypeEnum.TIEMPO)) {</span>
<span class="nc" id="L101">                    updatedMessage = &quot;Tiempo transcurrido: &quot; + value;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                } else if (eventData.getMessage().equals(MessageTypeEnum.ERRORARCHIVO)) {</span>
<span class="nc" id="L103">                    updatedMessage = &quot;Error en archivo: &quot; + value;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                } else if (eventData.getMessage().equals(MessageTypeEnum.IDLIBRO)) {</span>
<span class="nc" id="L105">                    updatedMessage = &quot;Activado Libro de Recetas: &quot; + value;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                } else if (eventData.getMessage().equals(MessageTypeEnum.ERRORENCSV)) {</span>
<span class="nc" id="L107">                    updatedMessage = &quot;No se encuentran los CSV en las lineas de Lista_1: &quot; + value;</span>
                } else {
<span class="nc" id="L109">                    updatedMessage = &quot;Error desconocido, por favor contacte con el Equipo de TI.&quot;;</span>
                }

<span class="nc" id="L112">                eventData.setMessage(updatedMessage);</span>
<span class="nc" id="L113">                emitter.send(SseEmitter.event().data(eventData, MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L114">            } catch (IOException e) {</span>
<span class="nc" id="L115">                emitter.completeWithError(e);</span>
<span class="nc" id="L116">            }</span>
<span class="nc" id="L117">        }</span>
<span class="nc" id="L118">    }</span>

    public synchronized void sendMessageAndCounters(String ovenName, String message, Integer contador,
            Integer contadorListaFiles)
            throws IOException {
<span class="nc bnc" id="L123" title="All 2 branches missed.">        for (SseEmitter emitter : emitters) {</span>
            try {
<span class="nc" id="L125">                OvenEventData eventData = new OvenEventData(ovenName, message);</span>
                String updatedMessage;

<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (eventData.getMessage().equals(MessageTypeEnum.TERMINADO)) {</span>
<span class="nc" id="L129">                    updatedMessage = &quot;Total de archivos procesados: [&quot; + contador + &quot;/&quot; + contadorListaFiles + &quot;]&quot;;</span>
                } else {
<span class="nc" id="L131">                    updatedMessage = &quot;Error desconocido, por favor contacte con el Equipo de TI.&quot;;</span>
                }

<span class="nc" id="L134">                eventData.setMessage(updatedMessage);</span>
<span class="nc" id="L135">                emitter.send(SseEmitter.event().data(eventData, MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L136">            } catch (IOException e) {</span>
<span class="nc" id="L137">                emitter.completeWithError(e);</span>
<span class="nc" id="L138">            }</span>
<span class="nc" id="L139">        }</span>
<span class="nc" id="L140">    }</span>

    @AllArgsConstructor
    @NoArgsConstructor
    @Data
    private static class OvenEventData {
        private String ovenName;
        private String message;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>