<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoginService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Poc Mercadona Backend</a> &gt; <a href="index.source.html" class="el_package">com.mercadona.poc.infraestructure.service</a> &gt; <span class="el_source">LoginService.java</span></div><h1>LoginService.java</h1><pre class="source lang-java linenums">package com.mercadona.poc.infraestructure.service;

import static com.mercadona.poc.constants.PocServerEnum.FILES;
import static com.mercadona.poc.constants.PocServerEnum.LOGIN_FORM;
import static com.mercadona.poc.constants.PocServerEnum.LOGIN_TOKEN;
import static com.mercadona.poc.constants.PocServerEnum.PROTOCOL;
import static com.mercadona.poc.constants.PocServerEnum.START_HTML;
import static com.mercadona.poc.constants.PocServerEnum.UP_SERVER;

import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.nio.charset.StandardCharsets;
import java.util.List;

import org.apache.http.Header;
import org.apache.http.HttpEntity;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.BasicCookieStore;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.apache.http.impl.cookie.BasicClientCookie;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.util.EntityUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.mercadona.poc.config.OvenPropertiesConfig;
import com.mercadona.poc.infraestructure.dto.LoginDTO;
import com.mercadona.poc.infraestructure.utilities.Utilities;

@Service
<span class="nc" id="L39">public class LoginService {</span>

	@Autowired
	private OvenPropertiesConfig properties;

<span class="nc" id="L44">	private static final Logger LOGGER = LoggerFactory.getLogger(SendFilesService.class);</span>

<span class="nc" id="L46">	String mtoken = null;</span>
<span class="nc" id="L47">	String stoken = null;</span>
<span class="nc" id="L48">	String cookie = null;</span>

	LoginDTO login(String ovenName) {
		// Service to login in the oven
<span class="nc" id="L52">		LoginDTO loginDTO = new LoginDTO();</span>
<span class="nc" id="L53">		loginDTO.setOvenHost(ovenName);</span>
<span class="nc" id="L54">		loginDTO.setUser(properties.getUsers().get(&quot;username&quot;));</span>
<span class="nc" id="L55">		loginDTO.setPassword(properties.getUsers().get(&quot;password&quot;));</span>

		try {
			// START URL
<span class="nc" id="L59">			String startUrl = PROTOCOL + loginDTO.getOvenHost() + START_HTML;</span>
<span class="nc" id="L60">			CloseableHttpClient client = Utilities.getClient();</span>
<span class="nc" id="L61">			URI address = new URI(startUrl);</span>
<span class="nc" id="L62">			HttpGet httpGet = new HttpGet(address);</span>

<span class="nc" id="L64">			CloseableHttpResponse response = client.execute(httpGet);</span>

<span class="nc" id="L66">			HttpEntity entity = response.getEntity();</span>
<span class="nc" id="L67">			String sResponse = EntityUtils.toString(entity);</span>
<span class="nc" id="L68">			response.close();</span>

			// SEND LOGIN FORM
<span class="nc" id="L71">			loginForm(client, response, entity, address, sResponse, loginDTO, startUrl);</span>

			// DO REDIRECT TO START URL
<span class="nc" id="L74">			redirect(client, response, entity, address, sResponse, loginDTO, startUrl);</span>

			// BROWSE FILE PAGE TO GET TOKENS
<span class="nc" id="L77">			sResponse = browseFiles(client, response, entity, address, sResponse, loginDTO, startUrl);</span>

			// Find Tokens for the sendFiles method when it redirects to the URL
<span class="nc" id="L80">			loginDTO = Utilities.findTokens(sResponse, loginDTO, this.stoken, this.mtoken);</span>
<span class="nc" id="L81">		} catch (Exception e) {</span>
<span class="nc" id="L82">			LOGGER.error(e.getMessage());</span>
<span class="nc" id="L83">			e.printStackTrace();</span>
<span class="nc" id="L84">		}</span>
<span class="nc" id="L85">		return loginDTO;</span>
	}

	// Login form to get the cookie
	private LoginDTO loginForm(CloseableHttpClient client, CloseableHttpResponse response, HttpEntity entity,
			URI address, String sResponse, LoginDTO loginDTO, String startUrl)
			throws URISyntaxException, IOException {
<span class="nc" id="L92">		address = new URI(PROTOCOL + loginDTO.getOvenHost() + LOGIN_FORM);</span>

<span class="nc" id="L94">		HttpPost httpPost = new HttpPost(address);</span>

<span class="nc" id="L96">		List&lt;BasicNameValuePair&gt; nameValuePairs = Utilities.prepareValues(loginDTO.getUser(), loginDTO.getPassword(),</span>
				LOGIN_TOKEN, startUrl);

<span class="nc" id="L99">		httpPost.setEntity(new UrlEncodedFormEntity(nameValuePairs, StandardCharsets.UTF_8));</span>
		// Response from the server after login
<span class="nc" id="L101">		response = client.execute(httpPost);</span>

<span class="nc" id="L103">		Header[] headers = response.getHeaders(&quot;set-cookie&quot;);</span>
<span class="nc" id="L104">		String h = headers[0].toString();</span>
<span class="nc" id="L105">		int posI = h.indexOf(&quot;siemens_ad_session=&quot;) + 19;</span>
<span class="nc" id="L106">		int posF = h.indexOf(&quot;;&quot;, posI);</span>
<span class="nc" id="L107">		cookie = h.substring(posI, posF);</span>
<span class="nc" id="L108">		loginDTO.setCookie(cookie);</span>

<span class="nc" id="L110">		entity = response.getEntity();</span>
<span class="nc" id="L111">		sResponse = EntityUtils.toString(entity);</span>
<span class="nc" id="L112">		response.close();</span>
<span class="nc" id="L113">		return loginDTO;</span>
	}

	// Browse files to get the tokens
	private String browseFiles(CloseableHttpClient client, CloseableHttpResponse response, HttpEntity entity,
			URI address, String sResponse, LoginDTO loginDTO, String startUrl)
			throws URISyntaxException, ClientProtocolException, IOException {
<span class="nc" id="L120">		address = new URI(PROTOCOL + loginDTO.getOvenHost() + FILES + UP_SERVER);</span>

<span class="nc" id="L122">		HttpGet httpGet = new HttpGet(address);</span>

<span class="nc" id="L124">		response = client.execute(httpGet);</span>

<span class="nc" id="L126">		entity = response.getEntity();</span>
<span class="nc" id="L127">		sResponse = EntityUtils.toString(entity);</span>
<span class="nc" id="L128">		response.close();</span>
<span class="nc" id="L129">		return sResponse;</span>
	}

	// Redirect to the start URL
	private LoginDTO redirect(CloseableHttpClient client, CloseableHttpResponse response, HttpEntity entity,
			URI address, String sResponse, LoginDTO loginDTO, String startUrl)
			throws URISyntaxException, ClientProtocolException, IOException {
<span class="nc" id="L136">		address = new URI(PROTOCOL + loginDTO.getOvenHost() + START_HTML);</span>

<span class="nc" id="L138">		final BasicCookieStore cookieStore = new BasicCookieStore();</span>
<span class="nc" id="L139">		final BasicClientCookie objCookie = new BasicClientCookie(&quot;siemens_ad_session&quot;, loginDTO.getCookie());</span>
<span class="nc" id="L140">		objCookie.setDomain(loginDTO.getOvenHost());</span>
<span class="nc" id="L141">		objCookie.setAttribute(&quot;domain&quot;, &quot;true&quot;);</span>
<span class="nc" id="L142">		objCookie.setPath(&quot;/&quot;);</span>
<span class="nc" id="L143">		cookieStore.addCookie(objCookie);</span>

<span class="nc" id="L145">		HttpGet httpGet = new HttpGet(address);</span>
<span class="nc" id="L146">		client = HttpClientBuilder.create().setDefaultCookieStore(cookieStore).build();</span>

<span class="nc" id="L148">		response = client.execute(httpGet);</span>

<span class="nc" id="L150">		entity = response.getEntity();</span>
<span class="nc" id="L151">		sResponse = EntityUtils.toString(entity);</span>
<span class="nc" id="L152">		response.close();</span>
<span class="nc" id="L153">		return loginDTO;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>