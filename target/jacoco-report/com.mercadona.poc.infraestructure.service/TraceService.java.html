<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TraceService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Poc Mercadona Backend</a> &gt; <a href="index.source.html" class="el_package">com.mercadona.poc.infraestructure.service</a> &gt; <span class="el_source">TraceService.java</span></div><h1>TraceService.java</h1><pre class="source lang-java linenums">package com.mercadona.poc.infraestructure.service;

import com.mercadona.poc.constants.MessageTypeEnum;
import com.mercadona.poc.domain.StartJobRequest;
import org.apache.commons.io.FileUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.MessageDigest;
import java.time.Duration;
import java.time.LocalTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.concurrent.CompletableFuture;

import static com.mercadona.poc.constants.PocConstansEnum.STATUS_ACCEPTED;

@Service
<span class="nc" id="L29">public class TraceService {</span>

    @Autowired
    SendFilesService sendFilesService;

    @Autowired
    SSEService emitterService;

<span class="nc" id="L37">    private static final Logger LOGGER = LoggerFactory.getLogger(TraceService.class);</span>


    public String getCurrentTrace() {
        // Logic for getCurrentTrace
<span class="nc" id="L42">        return STATUS_ACCEPTED;</span>
    }

    public ResponseEntity&lt;String&gt; startJob(StartJobRequest request) throws IOException {
<span class="nc" id="L46">        String[] ovenNames = request.getOvenList();</span>
<span class="nc" id="L47">        String pathFolder = determineFolderPath(request.getPathFolder());</span>

        try {
<span class="nc bnc" id="L50" title="All 2 branches missed.">            if (!validateFolderExists(pathFolder)) {</span>
<span class="nc" id="L51">                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;Folder not found!&quot;);</span>
            }

<span class="nc" id="L54">            copyFilesForOvens(pathFolder, ovenNames);</span>
<span class="nc" id="L55">            processFilesForOvensAsync(pathFolder, ovenNames);</span>

<span class="nc" id="L57">            LOGGER.info(&quot;Number of threads: {}&quot;, Thread.activeCount());</span>
<span class="nc" id="L58">            return ResponseEntity.ok(&quot;Number of threads: &quot; + Thread.activeCount());</span>
<span class="nc" id="L59">        } catch (Exception e) {</span>
<span class="nc" id="L60">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(&quot;An error occurred: &quot; + e.getMessage());</span>
        } finally {
<span class="nc" id="L62">            deleteFiles(ovenNames);</span>
        }
    }

    public List&lt;String&gt; getRecipeFolders() {
<span class="nc" id="L67">        List&lt;String&gt; recipeFolders = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L68">        String currentPath = System.getProperty(&quot;user.dir&quot;);</span>
<span class="nc" id="L69">        String parentDirectory = new File(currentPath).getParent();</span>
<span class="nc" id="L70">        final String pathFile = parentDirectory + &quot;/recetas/&quot;;</span>
<span class="nc" id="L71">        File recetasDir = new File(pathFile);</span>
<span class="nc bnc" id="L72" title="All 4 branches missed.">        if (recetasDir.exists() &amp;&amp; recetasDir.isDirectory()) {</span>
<span class="nc" id="L73">            File[] carpetas = recetasDir.listFiles();</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (carpetas != null) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                for (File carpeta : carpetas) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                    if (carpeta.isDirectory()) {</span>
<span class="nc" id="L78">                        recipeFolders.add(carpeta.getName());</span>
                    }
                }
            }
        }
<span class="nc" id="L83">        return recipeFolders;</span>
    }


    private String determineFolderPath(String pathFolderName) {
<span class="nc" id="L88">        String currentPath = System.getProperty(&quot;user.dir&quot;);</span>
<span class="nc" id="L89">        String parentDirectory = new File(currentPath).getParent();</span>
<span class="nc" id="L90">        return parentDirectory + &quot;/recetas/&quot; + pathFolderName;</span>
    }

    private boolean validateFolderExists(String pathFolder) {
<span class="nc" id="L94">        File folder = new File(pathFolder);</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">        if (folder.exists() &amp;&amp; folder.isDirectory()) {</span>
<span class="nc" id="L96">            LOGGER.info(&quot;Iniciando copiado de carpetas.&quot;);</span>
<span class="nc" id="L97">            return true;</span>
        }
<span class="nc" id="L99">        return false;</span>
    }

    private void copyFilesForOvens(String pathFolder, String[] ovenNames) throws Exception {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        for (String ovenName : ovenNames) {</span>
<span class="nc" id="L104">            String ovenCopyFolderName = ovenName + &quot;_&quot; + new File(pathFolder).getName();</span>
<span class="nc" id="L105">            File ovenCopyFolder = new File(new File(pathFolder).getParent(), ovenCopyFolderName);</span>
<span class="nc" id="L106">            copyDirectoryWithVerification(new File(pathFolder), ovenCopyFolder);</span>
        }
<span class="nc" id="L108">        LOGGER.info(&quot;Creando copias de carpetas...&quot;);</span>
<span class="nc" id="L109">    }</span>

    private void processFilesForOvensAsync(String pathFolder, String[] ovenNames) {
<span class="nc" id="L112">        List&lt;CompletableFuture&lt;Void&gt;&gt; ovenCopyFutures = new ArrayList&lt;&gt;();</span>

        // Process each oven's files asynchronously.
<span class="nc bnc" id="L115" title="All 2 branches missed.">        for (String ovenName : ovenNames) {</span>
<span class="nc" id="L116">            CompletableFuture&lt;Void&gt; ovenCopyFuture = CompletableFuture.runAsync(() -&gt; {</span>
                try {
<span class="nc" id="L118">                    String ovenCopyPath = createOvenCopyPath(pathFolder, ovenName);</span>
<span class="nc" id="L119">                    sendFileAndLogTime(ovenCopyPath, ovenName);</span>
<span class="nc" id="L120">                } catch (IOException | InterruptedException e) {</span>
<span class="nc" id="L121">                    handleAsyncException(e);</span>
<span class="nc" id="L122">                }</span>
<span class="nc" id="L123">            });</span>
<span class="nc" id="L124">            ovenCopyFutures.add(ovenCopyFuture);</span>
        }

        // Wait for all futures to complete.
<span class="nc" id="L128">        CompletableFuture&lt;Void&gt; allFutures = CompletableFuture.allOf(ovenCopyFutures.toArray(new CompletableFuture[0]));</span>
<span class="nc" id="L129">        allFutures.join();</span>
<span class="nc" id="L130">    }</span>

    private void sendFileAndLogTime(String ovenCopyPath, String ovenName) throws IOException, InterruptedException {
<span class="nc" id="L133">        LocalTime time1 = LocalTime.now();</span>

<span class="nc" id="L135">        sendFilesService.sendCookBook(ovenCopyPath, ovenName);</span>

<span class="nc" id="L137">        Duration elapsedTime = Duration.between(time1, LocalTime.now());</span>
<span class="nc" id="L138">        String message = elapsedTime.getSeconds() + &quot; segundos&quot;;</span>
<span class="nc" id="L139">        LOGGER.info(&quot;Tiempo transcurrido: {}&quot;, message);</span>
<span class="nc" id="L140">        emitterService.sendMessageAndValue(ovenName, MessageTypeEnum.TIEMPO, message);</span>
<span class="nc" id="L141">    }</span>

    private void handleAsyncException(Exception e) {
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (e instanceof IOException) {</span>
<span class="nc" id="L145">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L146">            throw new RuntimeException(&quot;Error occurred during task execution&quot;, e);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        } else if (e instanceof InterruptedException) {</span>
<span class="nc" id="L148">            throw new RuntimeException(e);</span>
        }
<span class="nc" id="L150">    }</span>

    // Create a copy of the file for each oven
    private String createOvenCopyPath(String originalFilePath, String ovenName) throws IOException {
<span class="nc" id="L154">        Path originalPath = Paths.get(originalFilePath);</span>
<span class="nc" id="L155">        String originalFileName = originalPath.getFileName().toString();</span>
<span class="nc" id="L156">        String ovenCopyFileName = ovenName + &quot;_&quot; + originalFileName;</span>

<span class="nc" id="L158">        Path ovenCopyPath = originalPath.getParent().resolve(ovenCopyFileName);</span>

<span class="nc" id="L160">        return ovenCopyPath.toString();</span>
    }

    // Delete the duplicated files
    private void deleteFiles(String[] ovenNames) throws IOException {
<span class="nc" id="L165">        String currentPath = System.getProperty(&quot;user.dir&quot;);</span>
<span class="nc" id="L166">        String parentDirectory = new File(currentPath).getParent();</span>
<span class="nc" id="L167">        final String recetasFolder = parentDirectory + &quot;/recetas/&quot;;</span>

<span class="nc" id="L169">        File recetasDir = new File(recetasFolder);</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">        if (recetasDir.exists() &amp;&amp; recetasDir.isDirectory()) {</span>
<span class="nc" id="L171">            File[] subfolders = recetasDir.listFiles();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (subfolders != null) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                for (File subfolder : subfolders) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                    if (subfolder.isDirectory()) {</span>
<span class="nc" id="L175">                        String folderName = subfolder.getName();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                        for (String ovenName : ovenNames) {</span>
<span class="nc" id="L177">                            String expectedPrefix = ovenName + &quot;_&quot;;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                            if (folderName.startsWith(expectedPrefix)) {</span>
<span class="nc" id="L179">                                FileUtils.deleteDirectory(subfolder);</span>
<span class="nc" id="L180">                                break;</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L187">    }</span>

    // Calculate the hash for a file
    private String calculateSHA256(Path filePath) throws Exception {
<span class="nc" id="L191">        MessageDigest sha256Digest = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="nc" id="L192">        byte[] fileBytes = Files.readAllBytes(filePath);</span>
<span class="nc" id="L193">        byte[] hashBytes = sha256Digest.digest(fileBytes);</span>
<span class="nc" id="L194">        return bytesToHex(hashBytes);</span>
    }

    // Checking both hashes
    private boolean isFileCopySuccessful(Path sourcePath, Path destPath) throws Exception {
<span class="nc" id="L199">        String sourceHash = calculateSHA256(sourcePath);</span>
<span class="nc" id="L200">        String destHash = calculateSHA256(destPath);</span>
<span class="nc" id="L201">        return sourceHash.equals(destHash);</span>
    }

    // Conversion bytes to Hex
    private String bytesToHex(byte[] bytes) {
<span class="nc" id="L206">        StringBuilder hexString = new StringBuilder(2 * bytes.length);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        for (int i = 0; i &lt; bytes.length; i++) {</span>
<span class="nc" id="L208">            String hex = Integer.toHexString(0xff &amp; bytes[i]);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (hex.length() == 1) {</span>
<span class="nc" id="L210">                hexString.append('0');</span>
            }
<span class="nc" id="L212">            hexString.append(hex);</span>
        }
<span class="nc" id="L214">        return hexString.toString();</span>
    }

    // Checking if the copy has been done correctly. If not, retry
    private void copyDirectoryWithVerification(File sourceFolder, File destFolder) throws Exception {
<span class="nc" id="L219">        FileUtils.copyDirectory(sourceFolder, destFolder);</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">        for (File sourceFile : Objects.requireNonNull(sourceFolder.listFiles())) {</span>
<span class="nc" id="L222">            File destFile = new File(destFolder, sourceFile.getName());</span>

<span class="nc" id="L224">            int retryCount = 0;</span>
<span class="nc" id="L225">            final int MAX_RETRIES = 5;</span>

<span class="nc bnc" id="L227" title="All 4 branches missed.">            while (!isFileCopySuccessful(sourceFile.toPath(), destFile.toPath()) &amp;&amp; retryCount &lt; MAX_RETRIES) {</span>
                // La copia fall√≥, volvemos a intentarlo
<span class="nc" id="L229">                FileUtils.copyFile(sourceFile, destFile);</span>
<span class="nc" id="L230">                retryCount++;</span>
            }

<span class="nc bnc" id="L233" title="All 2 branches missed.">            if (!isFileCopySuccessful(sourceFile.toPath(), destFile.toPath())) {</span>
<span class="nc" id="L234">                throw new IOException(</span>
<span class="nc" id="L235">                        &quot;Failed to copy file correctly after &quot; + MAX_RETRIES + &quot; attempts: &quot; + sourceFile.getName());</span>
            }
        }
<span class="nc" id="L238">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>